#!/usr/bin/env groovy
pipeline {
    agent any

    environment {
        dockerImage = ''
        JENKINS_USER_ID = "${sh(script: 'id -u', returnStdout: true).trim()}"
        JENKINS_GROUP_ID = "${sh(script: 'id -g', returnStdout: true).trim()}"
        currentWorkspace = ''
        TAG = "demo_${env.JOB_NAME}_${env.BUILD_NUMBER}"
    }

    options {
        timeout(time: 10, unit: 'MINUTES')
        skipDefaultCheckout()
    }

    stages {
        stage("Check Docker version") {
            steps {
                echo 'JENKINS_USER_ID'
                echo JENKINS_USER_ID
                echo 'JENKINS_GROUP_ID'
                echo JENKINS_GROUP_ID
                sh '''
                  docker version
                  docker info
                '''
            }
        }

        stage("Checkout") {
            steps {
                checkout scm
            }
        }

        stage("Cleaning and preparing") {
            steps {
                sh '''#!/bin/bash -e
                git clean -dfx
                mkdir reports
            '''
            }
        }


        stage('Docker System Prune') {
            steps {
                sh 'docker system prune -a --volumes -f'
            }
        }

        stage('Build an image with Tests') {

            agent {
                dockerfile {
                    filename 'Dockerfile'
                    args '-v $HOME/.m2:/root/.m2'
                    reuseNode true
                }
            }

            steps {
                sh """#!/bin/bash -e
                  docker version
                  docker info
                  docker-compose version
                  docker ps 
                  docker-compose config
                  docker-compose -p ${TAG} -f docker-compose-api.yaml up -d --no-color --build
                  docker-compose -p ${TAG} -f docker-compose-api.yaml run -e TYPE="@API" -u $JENKINS_USER_ID:$JENKINS_GROUP_ID api-test-service
                  docker ps 
                """
            }
        }


        stage('Stop all containers') {
            steps {
                sh """
                    docker-compose -p ${TAG} rm -f
                """
            }
        }

/*        stage('Build Image') {
            steps {
                script {
                    dockerImage = docker.build("docker-jenkins-automation:latest")
                    echo "image built"
                    sh 'docker image ls'
                    currentWorkspace = "$WORKSPACE"
                    echo "Current workspace 1 is ${currentWorkspace}"
                }
            }
        }*/

        /*stage('API Automation') {
            agent {
                docker {
                    image 'docker-jenkins-automation:latest'
                    label 'project-source-code-workspace-container'
                    args '-v $HOME/.m2:/root/.m2'
                    args '-v /var/jenkins_home/workspace/${JOB_NAME}:/usr/src/test-project -w /usr/src/test-project'
                    //args '-v $HOME/.m2:/var/maven/.m2'
                    //customWorkspace '/usr/src/test-project'
                    reuseNode true
                }
            }
            steps {
                sh '''#!/bin/bash
                    currentWorkspace = "$WORKSPACE"
                    echo "Current workspace 2 is ${currentWorkspace}"
                      echo "Check permissions 1"
                      echo "* Reuse node using new image "
                      echo "Within container using workspace as working directory.."
                      whoami
                      pwd
                      ls -lrt
                      echo "Target directory.."
                      mkdir -p target
                      ls -lrt
                      docker ps 
                      docker-compose config
                      echo "printenv"
                      printenv
                      chown -R $JENKINS_USER_ID:$JENKINS_GROUP_ID "$WORKSPACE"
                    chmod -R ug+rwx "$WORKSPACE"
                    whoami
                    pwd
                    ls -lrt
                    docker ps 
                    docker-compose -f docker-compose-api.yaml rm -f
                    docker-compose -f docker-compose-api.yaml up -d --no-color --build
                '''

*//*                echo "Switch to workspace.."
                dir('/var/jenkins_home/workspace/${JOB_NAME}') {
                    sh 'chown -R $JENKINS_USER_ID:$JENKINS_GROUP_ID ./run-api-tests.sh'
                    sh 'chmod ug+x ./run-api-tests.sh'
                    echo "run-api-tests.sh.."
                    sh './run-api-tests.sh'
                    docker ps
                }*//*

                step([$class: 'DockerComposeBuilder',
                         dockerComposeFile: 'docker-compose-api.yaml',
                         option: [$class: 'ExecuteCommandInsideContainer',
                         //command: '-e TYPE="@API" -u ${HOST_UID_GID} --entrypoint="./runner-api.sh"',
                                  command: './runner-api.sh',
                                  index: 0,
                                  privilegedMode: true,
                                  service: 'api-test-service',
                                  workDir: ''],
                         useCustomDockerComposeFile: true])
            }
        }*/

        stage('Generate HTML report') {
            steps {
                cucumber buildStatus: '',
                        reportTitle: 'Cucumber report',
                        fileIncludePattern: '**/*.json',
                        jsonReportDirectory: "reports/target",
                        trendsLimit: 10,
                        classifications: [
                                [
                                        'key'  : 'API',
                                        'value': 'API'
                                ]
                        ]
            }
        }
    }

    post {
        always {
            // publish html reports
            publishHTML target: [
                    allowMissing         : false,
                    alwaysLinkToLastBuild: false,
                    keepAll              : true,
                    reportDir            : "reports/target/Reports/",
                    reportFiles          : 'automated-test-report.html',
                    reportName           : 'Extent Test Report'
            ]
            publishHTML target: [
                    allowMissing         : false,
                    alwaysLinkToLastBuild: false,
                    keepAll              : true,
                    reportDir            : "reports/target/cucumber-html-report/",
                    reportFiles          : 'regression-tests.html',
                    reportName           : 'Cucumber Test Report'
            ]

            cleanWs()
        }
    }
}










